<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éŒ²éŸ³ã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 20px; }
        h1 { text-align: center; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        #controls { display: flex; justify-content: center; margin-bottom: 10px; }
        #recordings { margin-top: 15px; }
        .record-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: white; border-radius: 8px; }
        audio { display: block; margin-top: 5px; }
        .toolbar { display: flex; justify-content: center; margin-bottom: 15px; gap: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ¤ éŒ²éŸ³ã‚¢ãƒ—ãƒª</h1>

    <div id="controls">
        <button id="startBtn">éŒ²éŸ³é–‹å§‹</button>
        <button id="stopBtn" disabled>éŒ²éŸ³åœæ­¢</button>
        <select id="sortSelect">
            <option value="newest">æ–°ã—ã„é †</option>
            <option value="oldest">å¤ã„é †</option>
            <option value="longest">é•·ã„é †</option>
            <option value="shortest">çŸ­ã„é †</option>
        </select>
    </div>

    <div style="text-align: center; margin-bottom: 10px;">
    <input type="text" id="searchInput" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ—¥ä»˜ãƒ»æ–‡å­—èµ·ã“ã—ï¼‰" style="width: 80%; padding: 8px;">
</div>

    <div class="toolbar">
        <button id="deleteSelectedBtn">é¸æŠå‰Šé™¤</button>
        <button id="deleteAllBtn">å…¨éƒ¨å‰Šé™¤</button>
        <button id="downloadSelectedBtn">é¸æŠãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="downloadAllBtn">å…¨éƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="unselectAllBtn">é¸æŠå…¨éƒ¨è§£é™¤</button>
    </div>

    <p id="liveText">ã“ã“ã«éŒ²éŸ³ä¸­ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</p>
    <p id="recordingStatus" style="color: red; font-weight: bold; display: none;">ğŸ™ï¸ éŒ²éŸ³ä¸­...</p>
    <div id="recordings"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <script>

    function normalizeText(text) {
        return (text || "")
            .toLowerCase()
            .replace(/\s+/g, "") // ç©ºç™½ã‚’å‰Šé™¤
            .replace(/[ã-ã‚“]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) + 0x60) // ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠ
            )
            .replace(/[ãƒ¼ï¼â€•]/g, "") // é•·éŸ³ã‚’å‰Šé™¤
            .normalize("NFKC"); // å…¨è§’â†’åŠè§’ã€æ¿ç‚¹ãªã©ã®æ­£è¦åŒ–
    }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true;
        recognition.continuous = true;

        let isRecording = false;
        let finalTranscript = "";
        let tempTranscript = "";
        let mediaRecorder;
        let audioChunks = [];
        let recordings = JSON.parse(localStorage.getItem("recordings") || "[]");

        // éŒ²éŸ³ç•ªå·ã‚’éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
        let recordingCount = recordings.length > 0
            ? Math.max(...recordings.map(r => parseInt(r.title.replace("éŒ²éŸ³ ", ""))))
            : 0;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const liveText = document.getElementById('liveText');
        const recordingsDiv = document.getElementById('recordings');
        const sortSelect = document.getElementById('sortSelect');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');

        async function initRecorder() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (e) => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioURL = URL.createObjectURL(audioBlob);

                const title = `éŒ²éŸ³ ${++recordingCount}`;
                const date = new Date().toLocaleString("ja-JP", {
                    year: "numeric", month: "long", day: "numeric",
                    hour: "2-digit", minute: "2-digit"
                });

                const newRecording = {
                    id: Date.now(),
                    title,
                    audioURL,
                    transcript: finalTranscript || tempTranscript || "ï¼ˆæ–‡å­—ãªã—ï¼‰",
                    date,
                    duration: Math.round(audioBlob.size / 16000)
                };

                recordings.push(newRecording);
                localStorage.setItem("recordings", JSON.stringify(recordings));

                audioChunks = [];
                finalTranscript = "";
                tempTranscript = "";
                liveText.textContent = "ã“ã“ã«éŒ²éŸ³ä¸­ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...";

                renderRecordings();
            };
        }

        initRecorder();

        startBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === "inactive") {
                mediaRecorder.start();
            }

            isRecording = true;
            finalTranscript = "";
            tempTranscript = "";
            recognition.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;

            // éŒ²éŸ³ä¸­ã®è¡¨ç¤º
            const recordingStatus = document.getElementById('recordingStatus');
            recordingStatus.textContent = "ğŸ™ï¸ éŒ²éŸ³ä¸­...";
            recordingStatus.style.color = "red";
            recordingStatus.style.display = "block";
        });

        stopBtn.addEventListener('click', () => {
          //æœ€å¾Œã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰éŒ²éŸ³åœæ­¢
finalTranscript += tempTranscript;
          tempTranscript = "";

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
            isRecording = false;
            // éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢
               recognition.stop();
             liveText.textContent = "ã“ã“ã«éŒ²éŸ³ä¸­ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...";
            startBtn.disabled = false;
            stopBtn.disabled = true;

            const recordingStatus = document.getElementById('recordingStatus');
recordingStatus.style.display = "none";

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®é€”ä¸­çµŒéãƒ†ã‚­ã‚¹ãƒˆã‚’æ¶ˆã™
              tempTranscript = "";
              liveText.textContent = "ã“ã“ã«éŒ²éŸ³ä¸­ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...";

        });

        recognition.addEventListener('result', (event) => {
            tempTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                if (result.isFinal) {
                    finalTranscript += result[0].transcript;
                } else {
                    tempTranscript = result[0].transcript;
                }
            }
            liveText.textContent = finalTranscript + tempTranscript;
        });

        recognition.addEventListener('end', () => {
            if (isRecording) {recognition.start();

          } else {
                // éŒ²éŸ³åœæ­¢æ™‚ã¯å¿…ãšãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—ã‚’ã‚¯ãƒªã‚¢
                tempTranscript = "";
                liveText.textContent = "ã“ã“ã«éŒ²éŸ³ä¸­ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...";
                // -------------------
            }

        });

        function renderRecordings() {
            recordingsDiv.innerHTML = "";

            const keyword = normalizeText(searchInput.value);

               let filteredRecordings = recordings.filter(rec => {
                   const title = normalizeText(rec.title || "");
                   const date = normalizeText(rec.date || "");
                   const transcript = normalizeText(rec.transcript || "");

                   return (
                       title.includes(keyword) ||
                       date.includes(keyword) ||
                       transcript.includes(keyword)
                   );

            });
            let sorted = [...filteredRecordings];

            switch (sortSelect.value) {
                case "newest": sorted.sort((a, b) => b.id - a.id); break;
                case "oldest": sorted.sort((a, b) => a.id - b.id); break;
                case "longest": sorted.sort((a, b) => b.duration - a.duration); break;
                case "shortest": sorted.sort((a, b) => a.duration - b.duration); break;
            }

            sorted.forEach((rec) => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';

                recordItem.innerHTML = `
                    <input type="checkbox" class="selectRecording" data-id="${rec.id}">
                    <input type="text" class="editTitle" data-id="${rec.id}" value="${rec.title}" />
                    <p>ï¼ˆ${rec.date}ï¼‰</p>
                    <audio controls src="${rec.audioURL}"></audio>
                    <p>â± é•·ã•: ${rec.duration}ç§’</p>
                    <p>ğŸ“ <strong>æ–‡å­—èµ·ã“ã—:</strong><br>${rec.transcript || "ï¼ˆæ–‡å­—ãªã—ï¼‰"}</p>
                `;

                recordingsDiv.appendChild(recordItem);
            });

            document.querySelectorAll('.editTitle').forEach(input => {
                input.addEventListener('input', (e) => {
                    const id = Number(e.target.dataset.id);
                    const newTitle = e.target.value;
                    const recIndex = recordings.findIndex(r => r.id === id);
                    if (recIndex !== -1) {
                        recordings[recIndex].title = newTitle;
                        localStorage.setItem("recordings", JSON.stringify(recordings));
                    }
                });
            });
        }

        // éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’Blobã¨ã—ã¦å–å¾—
        async function fetchAudioBlob(url) {
            const res = await fetch(url);
            return await res.blob();
        }

        const unselectAllBtn = document.getElementById('unselectAllBtn');

unselectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('.selectRecording').forEach(checkbox => {
        checkbox.checked = false;
    });
});

        // é¸æŠã—ãŸéŒ²éŸ³ã‚’å‰Šé™¤
        deleteSelectedBtn.addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.selectRecording:checked'))
                .map(checkbox => Number(checkbox.dataset.id));

            recordings = recordings.filter(rec => !selected.includes(rec.id));
            localStorage.setItem("recordings", JSON.stringify(recordings));
            renderRecordings();
        });

        // å…¨éƒ¨å‰Šé™¤
        deleteAllBtn.addEventListener('click', () => {
            if (confirm("æœ¬å½“ã«å…¨éƒ¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                recordings = [];
                localStorage.removeItem("recordings");
                recordingCount = 0;
                renderRecordings();
            }
        });

        // é¸æŠã—ãŸéŒ²éŸ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadSelectedBtn.addEventListener('click', async () => {
            const selected = Array.from(document.querySelectorAll('.selectRecording:checked'))
                .map(checkbox => Number(checkbox.dataset.id));

            if (selected.length === 0) {
                alert("éŒ²éŸ³ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
                return;
            }

            const zip = new JSZip();
            for (const rec of recordings.filter(r => selected.includes(r.id))) {
                const blob = await fetchAudioBlob(rec.audioURL);
                zip.file(`${rec.title}.webm`, blob);
            }

            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "é¸æŠã—ãŸéŒ²éŸ³.zip";
            link.click();
        });

        // å…¨éƒ¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadAllBtn.addEventListener('click', async () => {
            if (recordings.length === 0) {
                alert("éŒ²éŸ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
                return;
            }

            const zip = new JSZip();
            for (const rec of recordings) {
                const blob = await fetchAudioBlob(rec.audioURL);
                zip.file(`${rec.title}.webm`, blob);
            }

            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "å…¨éƒ¨ã®éŒ²éŸ³.zip";
            link.click();
        });

        sortSelect.addEventListener('change', renderRecordings);

        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", () => {
            renderRecordings();
        });

        renderRecordings();
    </script>
</body>
</html>
